with t0 as (select "report_lab_seed_operate_reports"),      t1 as (        select ymd_new_seed, count(aid) activation_count  from warehouse.user u where ymd_new_seed between 20180522 and 20180528  group by ymd_new_seed       ),      t2 as (        with t as        (        SELECT          u.ymd_new_seed,          s.aid,          s.hist_command_id,          s.hist_command_state,          s.hist_event,          s.hist_result                  FROM          warehouse.user u         INNER JOIN            warehouse.seed1 s         ON           u.aid = s.aid         WHERE          ymd_new_seed between 20180522 AND 20180528 AND s.ymd >= 20180522         GROUP BY          ymd_new_seed ,aid, hist_command_id,hist_command_state,hist_event,hist_result         )        select          ymd_new_seed,           sum(if(hist_command_id='legacy_active' AND hist_command_state = 'SUCCESS',1,0)) as active_count,          sum(if(hist_command_id = 'legacy_native'  AND hist_command_state = 'SUCCESS' AND hist_event = 'installed' AND hist_result = 'true',1,0)) as installed_count                  from t group by ymd_new_seed  order by ymd_new_seed      ),      t3 as (         select u.ymd_new_seed , count(aid) dm_active  from warehouse.user u         where u.ymd_new_seed between 20180522 and 20180528         and u.ymd_last_dm >= 20180522         group by u.ymd_new_seed  order by u.ymd_new_seed      ),      t4 as (        select u.ymd_new_seed , count(aid) v9_active  from warehouse.user u        where u.ymd_new_seed between 20180522 and 20180528         and u.ymd_last_pay >= 20180522 and substr(u.version_pay, 1, 1) = '9'         group by u.ymd_new_seed  order by u.ymd_new_seed       ),      t5 as (        select u.ymd_new_seed , count(aid) v9_effective  from warehouse.user u        where u.ymd_new_seed between 20180522 and 20180528         and u.ymd_last_pay >= 20180522 and substr(u.version_pay, 1, 1) = '9'         and u.imsi_pay is not null and substr(CAST(u.imsi_pay as string),1,3) = '460' and length(CAST(u.imsi_pay as string))=15         group by u.ymd_new_seed  order by u.ymd_new_seed       )      select      t1.ymd_new_seed as ymd, t1.activation_count as ework_activation,t2.active_count, t2.active_count/t1.activation_count as active_count_ratio,      t2.installed_count, t2.installed_count/t1.activation_count as installed_count_ratio,      t3.dm_active, t3.dm_active/t1.activation_count as dm_active_ratio,       t4.v9_active, t4.v9_active/t1.activation_count as v9_active_ratio,      t5.v9_effective, t5.v9_effective/t1.activation_count as v9_effective_ratio       from t1       left join t2 on t1.ymd_new_seed = t2.ymd_new_seed       left join t3 on t1.ymd_new_seed = t3.ymd_new_seed       left join t4 on t1.ymd_new_seed = t4.ymd_new_seed       left join t5 on t1.ymd_new_seed = t5.ymd_new_seed       order by t1.ymd_new_seed         UNION ALL (        with today_base as (        select aid,hist_command_id_last_seed,ymd_last_dm,ymd_last_pay,imsi_pay,tag0, tag, android_sdk_app from warehouse.user u where u.ts_new_seed between '2018-05-29 00:00:00' and '2018-05-29 16:00:00'          ),        seed_installed as (        select aid from warehouse.seed1 where day = 29 and ymd>=20180529  and hist_command_id = 'legacy_native' AND hist_command_state = 'SUCCESS' AND hist_event = 'installed' AND hist_result = 'true'         ),        today_installed_count as (        select count(1) count  from seed_installed right semi join today_base on seed_installed.aid=today_base.aid          ),        today_other as (        select        count(1) as ework_activation,        sum(if(hist_command_id_last_seed is not NULL,1,0)) as active_count,        sum(if(ymd_last_dm >= 20180529,1,0)) as dm_active,        sum(if(ymd_last_pay >= 20180529,1,0)) as v9_active,        sum(if(ymd_last_pay >= 20180529 and imsi_pay is not null and substr(CAST(imsi_pay as string),1,3) = '460' and length(CAST(imsi_pay as string))=15,1,0)) as v9_effective         from today_base          )        select        20180529 as ymd,        today_other.ework_activation,        today_other.active_count,        today_other.active_count/today_other.ework_activation as active_count_ratio,        today_installed_count.count as installed_count,        today_installed_count.count/today_other.ework_activation as installed_count_ratio,        today_other.dm_active,        today_other.dm_active/today_other.ework_activation as dm_active_ratio,        today_other.v9_active,        today_other.v9_active/today_other.ework_activation as v9_active_ratio,        today_other.v9_effective,        today_other.v9_effective/today_other.ework_activation as v9_effective_ratio         from today_other ,today_installed_count      );







with t0 as (select "report_lab_seed_operate_reports"),      t1 as (        select ymd_new_seed, count(aid) activation_count  from warehouse.user u where ymd_new_seed between 20180522 and 20180528  group by ymd_new_seed       ),      t2 as (        with t as        (        SELECT          u.ymd_new_seed,          s.aid,          s.hist_command_id,          s.hist_command_state,          s.hist_event,          s.hist_result                  FROM          warehouse.user u         INNER JOIN            warehouse.seed1 s         ON           u.aid = s.aid         WHERE          ymd_new_seed between 20180522 AND 20180528 AND s.ymd >= 20180522         GROUP BY          ymd_new_seed ,aid, hist_command_id,hist_command_state,hist_event,hist_result         )        select          ymd_new_seed,           sum(if(hist_command_id='legacy_active' AND hist_command_state = 'SUCCESS',1,0)) as active_count,          sum(if(hist_command_id = 'legacy_native'  AND hist_command_state = 'SUCCESS' AND hist_event = 'installed' AND hist_result = 'true',1,0)) as installed_count                  from t group by ymd_new_seed  order by ymd_new_seed      ),      t3 as (         select u.ymd_new_seed , count(aid) dm_active  from warehouse.user u         where u.ymd_new_seed between 20180522 and 20180528         and u.ymd_last_dm >= 20180522         group by u.ymd_new_seed  order by u.ymd_new_seed      ),      t4 as (        select u.ymd_new_seed , count(aid) v9_active  from warehouse.user u        where u.ymd_new_seed between 20180522 and 20180528         and u.ymd_last_pay >= 20180522 and substr(u.version_pay, 1, 1) = '9'         group by u.ymd_new_seed  order by u.ymd_new_seed       ),      t5 as (        select u.ymd_new_seed , count(aid) v9_effective  from warehouse.user u        where u.ymd_new_seed between 20180522 and 20180528         and u.ymd_last_pay >= 20180522 and substr(u.version_pay, 1, 1) = '9'         and u.imsi_pay is not null and substr(CAST(u.imsi_pay as string),1,3) = '460' and length(CAST(u.imsi_pay as string))=15         group by u.ymd_new_seed  order by u.ymd_new_seed       )      select      t1.ymd_new_seed as ymd, t1.activation_count as ework_activation,t2.active_count, t2.active_count/t1.activation_count as active_count_ratio,      t2.installed_count, t2.installed_count/t1.activation_count as installed_count_ratio,      t3.dm_active, t3.dm_active/t1.activation_count as dm_active_ratio,       t4.v9_active, t4.v9_active/t1.activation_count as v9_active_ratio,      t5.v9_effective, t5.v9_effective/t1.activation_count as v9_effective_ratio       from t1       left join t2 on t1.ymd_new_seed = t2.ymd_new_seed       left join t3 on t1.ymd_new_seed = t3.ymd_new_seed       left join t4 on t1.ymd_new_seed = t4.ymd_new_seed       left join t5 on t1.ymd_new_seed = t5.ymd_new_seed       order by t1.ymd_new_seed         UNION ALL (        with today_base as (        select aid,hist_command_id_last_seed,ymd_last_dm,ymd_last_pay,imsi_pay,tag0, tag, android_sdk_app from warehouse.user u where u.ts_new_seed between '2018-05-29 00:00:00' and '2018-05-29 16:00:00'          ),        seed_installed as (        select aid from warehouse.seed1 where day = 29 and ymd>=20180529  and hist_command_id = 'legacy_native' AND hist_command_state = 'SUCCESS' AND hist_event = 'installed' AND hist_result = 'true'         ),        today_installed_count as (        select count(1) count  from seed_installed right semi join today_base on seed_installed.aid=today_base.aid          ),        today_other as (        select        count(1) as ework_activation,        sum(if(hist_command_id_last_seed is not NULL,1,0)) as active_count,        sum(if(ymd_last_dm >= 20180529,1,0)) as dm_active,        sum(if(ymd_last_pay >= 20180529,1,0)) as v9_active,        sum(if(ymd_last_pay >= 20180529 and imsi_pay is not null and substr(CAST(imsi_pay as string),1,3) = '460' and length(CAST(imsi_pay as string))=15,1,0)) as v9_effective         from today_base          )        select        20180529 as ymd,        today_other.ework_activation,        today_other.active_count,        today_other.active_count/today_other.ework_activation as active_count_ratio,        today_installed_count.count as installed_count,        today_installed_count.count/today_other.ework_activation as installed_count_ratio,        today_other.dm_active,        today_other.dm_active/today_other.ework_activation as dm_active_ratio,        today_other.v9_active,        today_other.v9_active/today_other.ework_activation as v9_active_ratio,        today_other.v9_effective,        today_other.v9_effective/today_other.ework_activation as v9_effective_ratio         from today_other ,today_installed_count      );